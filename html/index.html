<!DOCTYPE html>
<html>
    <head>
        <title>Drought-Monitor</title>
        <meta charset="utf-8"/>
        <!--         <script type="module">
        import * as hdf5 from '../jsfive/index.js';
        window.hdf5 = hdf5;
        </script> -->
        <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js'></script>
        <script src="https://cdn.jsdelivr.net/npm/vega@5.4.0/build/vega.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/vega-lite@3.3.0/build/vega-lite.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/vega-embed@4.2.0/build/vega-embed.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/spark-md5/3.0.0/spark-md5.min.js"></script>
        <script src="https://sdk.amazonaws.com/js/aws-sdk-2.283.1.min.js"></script>
        <style media="screen">
            /* Add space between Vega-Embed links  */
            .vega-actions a {
                margin-right: 5px;
            }
        </style>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
        <!-- Make sure you put this AFTER Leaflet's CSS -->
        <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>
    </head>
    <body>
        <div id="controls" style="width:100%;">
            <h1>Drought-Monitor</h1>
            &nbsp &nbsp &nbsp &nbsp<input type="number" name="lat" id="lat" min="-90" max="90" onchange="updatePlot()"/>
            Latitude (WGS84)
            &nbsp<input type="number" name="lon" id="lon" min="-180" max="180" onchange="updatePlot()"/>
            Longitude (WGS84)
            
            
            
            
            
            
            
            <select name="axisType" id="axisType" onchange="updatePlot()">
                <option value="NDMI">Time NDMI</option>
                <option value="SM">Time Soil Moisture</option>
                <option value="MAP">Current Map</option>
            </select>
        </div>
        <!-- Container for the visualization -->
        <div id="vis" style="width:100%"></div>
        <!-- Container for the slippy map -->
        <div id="map" style="width:100%"></div>
        <div id="message"></div>
        <div id="fcc-message">This product uses the FCC Data API but is not endorsed or certified by the FCC.
        </div>
        <script>

            // Functions used throughout //

            function getPODPACLambda(cfg, pipeline, coordinates, name, rData) {
                if (pipeline === null | coordinates === null) {
                    return;
                }

                func = function(err, data) {
                    if (err)
                        console.log(err, err.stack);
                    else {
                        addRawData(rData, JSON.parse(String.fromCharCode.apply(null, data.Body)), name);
                    }
                }

                if (cfg.s3 !== null) {
                    let postFilename = Object.keys(pipeline.nodes)[Object.keys(pipeline.nodes).length - 1] + '_output_' + SparkMD5.hash(JSON.stringify({
                        'nodes': pipeline.nodes
                    })) + '_' + SparkMD5.hash('output') + '_' + SparkMD5.hash(JSON.stringify(coordinates)) + '.json';
                    // Make the full pipeline json
                    let pipeline_json = JSON.stringify({
                        'pipeline': pipeline,
                        'coordinates': coordinates
                    });
                    cfg.s3.upload({
                        Key: cfg.inFolder + '/' + postFilename,
                        Body: pipeline_json,
                        ACL: "public-read"
                    }, function(err, data) {
                        if (err) {
                            console.log(err);
                            return alert("there was and error: ", err.message);
                        }
                    });
                    cfg.s3.waitFor('objectExists', {
                        Key: cfg.outFolder + '/' + postFilename,
                        $waiter: {
                            delay: 10,
                            maxAttempts: 24
                        }
                    }, function(err, data) {
                        if (err)
                            console.log(err, err.stack);
                        else {
                            cfg.s3.getObject({
                                Key: cfg.outFolder + '/' + postFilename
                            }, func);
                        }
                    });
                }
            }

            function addRawData(rData, data, name) {
                for (let i = 0; i < data.coords.time.data.length; i++) {
                    let key = data.coords.time.data[i].slice(0, 10).replace(/-/g, '\/');
                    if (rData[key] === undefined) {
                        rData[key] = {};
                    }
                    rData[key][name] = data.data[0][0][i];
                }
                return rData;
            }

            // Function that retrieves the data -- returns dummy data for now
            function get_data(geolocation, rawData) {
                if (geolocation === null | rawData == null) {
                    return;
                }
                // To retrieve the NDMI data we need the county fips code -- use the fcc's census api to get this from the lat/lon
                var fips_request;
                var fips_json = null;
                var fips_code_county = null;
                var rawNDMI = null;

                var nowdate = new Date();
                var offsetdate = new Date();
                offsetdate.setMonth(Math.max(0, nowdate.getMonth() - 3));

                var enddate = nowdate.toLocaleDateString();
                var startdate = offsetdate.toLocaleDateString();

                offsetdate.setDate(Math.max(0, nowdate.getDate() - 7));

                // Fill the coordinates template
                if (coords !== null) {
                    for (let i = 0; i < coords.coords.length; i++) {
                        if (coords.coords[i].name == "lat") {
                            coords.coords[i].values = [parseFloat(geolocation[0])];
                        } else if (coords.coords[i].name == "lon") {
                            coords.coords[i].values = [parseFloat(geolocation[1])];
                        } else if (coords.coords[i].name == "time") {
                            coords.coords[i].start = offsetdate.toISOString().slice(0, 10);
                            coords.coords[i].stop = nowdate.toISOString().slice(0, 10);
                        }
                    }
                    // Fetch the PODPAC pipeline data\
                    // The next snippet should go in podpac.js 
                    //                     let drought_category = null;
                    //                     getPODPACLambda(PODPACcfg, pipeline_category, coords, function(json) {
                    //                         drought_category = json;
                    //                         if (rawData.SMAP.length == 0){
                    //                             rawData = initSMAPRawData(rawData, drought_category, "category");
                    //                         } else {
                    //                             rawData = addSMAPRawData(rawData, drought_category, "category");
                    //                         }
                    //                     });
                    getPODPACLambda(PODPACcfg, pipeline_category, coords, 'category', rawData.SMAP);
                    getPODPACLambda(PODPACcfg, pipeline_moisture, coords, 'moisture', rawData.SMAP);
                    getPODPACLambda(PODPACcfg, pipeline_d0, coords, 'd0', rawData.SMAP);
                    getPODPACLambda(PODPACcfg, pipeline_d1, coords, 'd1', rawData.SMAP);
                    getPODPACLambda(PODPACcfg, pipeline_d2, coords, 'd2', rawData.SMAP);
                    getPODPACLambda(PODPACcfg, pipeline_d3, coords, 'd3', rawData.SMAP);
                    getPODPACLambda(PODPACcfg, pipeline_d4, coords, 'd4', rawData.SMAP);
                }

                // Fetch the NDMI data
                $.get('https://geo.fcc.gov/api/census/area', {
                    lat: $('#lat')[0].value,
                    lon: $('#lon')[0].value,
                    format: 'json'
                }, function(data) {
                    fips_json = data;
                    if (fips_json.results.length > 0) {
                        fips_code_county = fips_json.results[0].county_fips;
                    } else {
                        return;
                    }

                    // Get the NDMI data
                    // example https://usdmdataservices.unl.edu/api/USStatistics/GetDroughtSeverityStatisticsByArea?aoi=us&startdate=1/1/2019&enddate=1/1/2020&statisticsType=1
                    $.ajax({
                        url: 'https://cors-anywhere.herokuapp.com/https://usdmdataservices.unl.edu/api/CountyStatistics/GetDroughtSeverityStatisticsByArea',
                        type: 'GET',
                        contentType: 'text/plain',
                        xhrFields: {
                            withCredentials: false
                        },
                        data: {
                            aoi: fips_code_county,
                            startdate: startdate,
                            enddate: enddate,
                            statisticsType: 1
                        },
                        accepts: 'json',
                        success: function(data) {
                            // we'll need to get this through podpac for the dates in rawNDMI
                            cats = {
                                d5: null,
                                d4: null,
                                d3: null,
                                d2: null,
                                d1: null,
                                d0: null,
                                dn: null
                            }
                            let rawNDMI = data;
                            let times = [];
                            for (let i = 0; i < rawNDMI.length; i++) {
                                var tot_area = parseFloat(rawNDMI[i]["None"].replace(',', ''));
                                var mean_cat = 5.5 * tot_area;
                                for (var j = 0; j < 5; j++) {
                                    var area = parseFloat(rawNDMI[i]["D" + j].replace(',', ''));
                                    tot_area = tot_area + area;
                                    mean_cat = mean_cat + (4.5 - j) * area;
                                }
                                let locNDMI = mean_cat / tot_area;
                                let key = rawNDMI[i].MapDate;
                                // Standardize date representation
                                key = key.slice(0, 4) + '-' + key.slice(4, 6) + '-' + key.slice(6, 8)
                                times.push(key);
                                key = key.replace(/-/g, '\/');
                                rawData.NDMI[key] = {
                                    NDMI: locNDMI
                                };
                            }
                            // Ammend/fix the NDMI data with categories (for translation to soil moisture)
                            if (coords2 !== null) {
                                for (let i = 0; i < coords2.coords.length; i++) {
                                    if (coords2.coords[i].name == "lat") {
                                        coords2.coords[i].values = [parseFloat(geolocation[0])];
                                    } else if (coords2.coords[i].name == "lon") {
                                        coords2.coords[i].values = [parseFloat(geolocation[1])];
                                    } else if (coords2.coords[i].name == "time") {
                                        coords2.coords[i].values = times;
                                    }
                                }
                                getPODPACLambda(PODPACcfg, pipeline_d0, coords2, 'd0', rawData.NDMI);
                                getPODPACLambda(PODPACcfg, pipeline_d1, coords2, 'd1', rawData.NDMI);
                                getPODPACLambda(PODPACcfg, pipeline_d2, coords2, 'd2', rawData.NDMI);
                                getPODPACLambda(PODPACcfg, pipeline_d3, coords2, 'd3', rawData.NDMI);
                                getPODPACLambda(PODPACcfg, pipeline_d4, coords2, 'd4', rawData.NDMI);
                            }
                            updatePlot();
                        }
                    });
                });

                return rawData;
            }

            // Function that converts soil moisture to NDMI based on the drought categories
            function soilmoistureToNDMI(data) {
                outData = {
                    "values": []
                }
                let SMAPentries = Object.entries(data.SMAP);
                let NDMIentries = Object.entries(data.NDMI);
                for (var i = 0; i < SMAPentries.length; i++) {
                    outData.values.push({});
                    var sm = 0;
                    var ndmi = 0;

                    outData.values[i].moisture = SMAPentries[i][1].category;
                    outData.values[i].d5 = 0;
                    outData.values[i].d4 = 1;
                    outData.values[i].d3 = 2;
                    outData.values[i].d2 = 3;
                    outData.values[i].d1 = 4;
                    outData.values[i].d0 = 5;
                    outData.values[i].dn = 6;
                    outData.values[i].date1 = SMAPentries[i][0];

                }
                for (var i = 0; i < NDMIentries.length; i++) {
                    outData.values.push({});

                    // No conversion needed
                    outData.values[i].NDMI = NDMIentries[i][1].NDMI;
                    outData.values[i].date = NDMIentries[i][0];
                }
                return outData;
            }

            // Function that converts NDMI to soil moisture based on the drought categories
            function NDMIToSoilmoisture(data) {
                outData = {
                    "values": []
                }
                let SMAPentries = Object.entries(data.SMAP);
                let NDMIentries = Object.entries(data.NDMI);
                for (var i = 0; i < NDMIentries.length; i++) {
                    outData.values.push({});

                    if (NDMIentries[i][1].NDMI < 1) {
                        NDMI = (NDMIentries[i][1].NDMI - 0) * (NDMIentries[i][1].d4 - 0) + 0;
                    } else if (NDMIentries[i][1].NDMI < 2) {
                        NDMI = (NDMIentries[i][1].NDMI - 1) * (NDMIentries[i][1].d3 - NDMIentries[i][1].d4) + NDMIentries[i][1].d4;
                    } else if (NDMIentries[i][1].NDMI < 3) {
                        NDMI = (NDMIentries[i][1].NDMI - 2) * (NDMIentries[i][1].d2 - NDMIentries[i][1].d3) + NDMIentries[i][1].d3;
                    } else if (NDMIentries[i][1].NDMI < 4) {
                        NDMI = (NDMIentries[i][1].NDMI - 3) * (NDMIentries[i][1].d1 - NDMIentries[i][1].d2) + NDMIentries[i][1].d2;
                    } else if (NDMIentries[i][1].NDMI < 5) {
                        NDMI = (NDMIentries[i][1].NDMI - 4) * (NDMIentries[i][1].d0 - NDMIentries[i][1].d1) + NDMIentries[i][1].d1;
                    } else {
                        NDMI = (NDMIentries[i][1].NDMI - 5) * (0.5 - NDMIentries[i][1].d0) + NDMIentries[i][1].d0;
                    }
                    outData.values[i].NDMI = NDMI;
                    outData.values[i].date = NDMIentries[i][0];

                }
                for (var i = 0; i < SMAPentries.length; i++) {
                    outData.values.push({});
                    // No conversion needed
                    outData.values[i].moisture = SMAPentries[i][1].moisture;
                    outData.values[i].d5 = 0;
                    outData.values[i].d4 = SMAPentries[i][1].d4;
                    outData.values[i].d3 = SMAPentries[i][1].d3;
                    outData.values[i].d2 = SMAPentries[i][1].d2;
                    outData.values[i].d1 = SMAPentries[i][1].d1;
                    outData.values[i].d0 = SMAPentries[i][1].d0;
                    outData.values[i].dn = 0.5;
                    outData.values[i].date1 = SMAPentries[i][0];
                }
                return outData;
            }

            function get_geolocation() {
                new_geolocation = [$('#lat')[0].value, $('#lon')[0].value]
                if (new_geolocation[0] !== '' & new_geolocation[1] !== "") {
                    geolocation = new_geolocation;
                    return;
                }

                function setPosition(position) {
                    $('#lat')[0].value = position.coords.latitude;
                    $('#lon')[0].value = position.coords.longitude;
                    geolocation = [position.coords.latitude, position.coords.longitude];
                    updatePlot();
                }
                function showError(error) {
                    x = $('#message')[0];
                    geolocation = undefined;
                    switch (error.code) {
                    case error.PERMISSION_DENIED:
                        x.innerHTML = "User denied the request for Geolocation."
                        $("#axisType")[0].value = "MAP"
                        break;
                    case error.POSITION_UNAVAILABLE:
                        x.innerHTML = "Location information is unavailable."
                        break;
                    case error.TIMEOUT:
                        x.innerHTML = "The request to get user location timed out."
                        break;
                    case error.UNKNOWN_ERROR:
                        x.innerHTML = "An unknown error occurred."
                        break;
                    }
                }

                if (navigator.geolocation) {
                    if (geolocation === null) {
                        navigator.geolocation.getCurrentPosition(setPosition, showError);
                    }
                } else {
                    $('#message')[0].innerHTML = "Geolocation is not supported by this browser. Please enter location manually.";
                    geolocation = undefined;
                }
            }

            // Define the colors for the legend
            var legend = {
                "DN": "#FFFFFF",
                "D0": "#FFFF00",
                "D1": "#FCD37F",
                "D2": "#FFAA00",
                "D3": "#E60000",
                "D4": "#730000"
            }

            // Get the height for the map and plot elements
            function get_height() {
                var margin = $('body').css('margin').replace('px', '');
                if (margin === "") {
                    margin = 0;
                } else {
                    margin = parseInt(margin);
                }
                return $(window).height() - $('#controls').height() - $('#message').height() - $('#fcc-message').height() - margin * 2 - 16;
            }

            // Updates the plot data depending on user selections
            function updatePlot() {
                get_geolocation();

                if (geolocation === null | geolocation === undefined) {
                    return;
                }
                if ((rawData === null) | (old_geolocation[0] != geolocation[0]) | (old_geolocation[1] != geolocation[1])) {
                    rawData = {
                        SMAP: {},
                        NDMI: {}
                    };
                    rawData = get_data(geolocation, rawData);
                    old_geolocation = geolocation;
                }
                if (marker !== null) {
                    marker.removeFrom(map);
                }
                marker = L.marker(geolocation, {
                    draggable: true
                }).addTo(map);
                marker.on('dragend', function() {
                    var coords = marker.getLatLng();
                    $("#lat")[0].value = coords['lat'];
                    $("#lon")[0].value = coords['lng'];
                    updatePlot();
                })

                var data = null;
                var domain = null;
                var axis = {
                    "labelFontSize": 24,
                    "titleFontSize": 24,
                }
                if ($('#axisType')[0].value === "NDMI") {
                    data = soilmoistureToNDMI(rawData);
                    domain = [0, 6];
                    axis.title = "Drought Category";
                    axis.tickCount = 0;
                    $("#vis").show();
                    $("#map").hide();

                } else if ($('#axisType')[0].value === "SM") {
                    data = NDMIToSoilmoisture(rawData);
                    //                     domain = [Math.min.apply(Math, rawData.SMAP.map(function(o) {
                    //                         if (o.moisture === undefined) {
                    //                             return 1;
                    //                         } else {
                    //                             return o.moisture;
                    //                         }
                    //                     })), Math.max.apply(Math, rawData.SMAP.map(function(o) {
                    //                         if (o.moisture == undefined) {
                    //                             return 0;
                    //                         } else {
                    //                             return o.moisture;
                    //                         }
                    //                     }))];
                    let smapMax = Math.max.apply(Math, Object.values(rawData.SMAP).map(function(o) {
                        if (o.moisture == undefined) {
                            return 0;
                        } else {
                            return o.moisture;
                        }
                    }));
                    let ndmiMax = Math.max.apply(Math, Object.values(rawData.NDMI).map(function(o) {
                        if (o.moisture == undefined) {
                            return 0;
                        } else {
                            return o.moisture;
                        }
                    }));
                    domain = [0, Math.max([ndmiMax, smapMax])];
                    axis.title = "Soil Moisture";
                    axis.tickCount = 5;
                    $("#vis").show();
                    $("#map").hide();

                } else if ($('#axisType')[0].value === "MAP") {
                    $("#vis").hide();
                    $("#map").show();
                }
                var vlSpec = makeVLSpec(data, domain, axis);

                vlSpec["height"] = get_height();

                // Embed the visualization in the container with id `vis`
                vegaEmbed('#vis', vlSpec);
            }

            // Makes the JSON spec for the Vega-lite plot
            function makeVLSpec(data, domain, axis) {
                var vlSpec = {
                    $schema: 'https://vega.github.io/schema/vega-lite/v3.json',
                    "width": $('#vis').width(),
                    "height": $(window).height() - $('#controls').height() - $('#message').height(),
                    "autosize": {
                        "type": "fit",
                        "contains": "padding"
                    },
                    "data": data,

                    "layer": [// Each Entry in the Layers define a plot
                    {
                        // Cat 4 drought area layer
                        "mark": {
                            "opacity": 1.0,
                            "type": "area",
                            "color": legend["D4"]
                        },
                        "encoding": {
                            "y": {
                                "field": "d4",
                                "scale": {
                                    "domain": domain
                                },
                                "type": "quantitative",
                                "axis": axis,
                            },
                            "y2": {
                                "field": "d5",
                                "type": "quantitative"
                            },
                            "x": {
                                // This defines the x-axis and label
                                "field": "date1",
                                "type": "temporal",
                                "axis": {
                                    "title": "",
                                },
                                "scale": {
                                    "domain": {
                                        "selection": "brush"
                                    }
                                }
                            },
                            "tooltip": null
                        }
                    }, {
                        // Cat 3 drought area layer
                        "mark": {
                            "opacity": 1.0,
                            "type": "area",
                            "color": legend["D3"]
                        },
                        "encoding": {
                            "y": {
                                "field": "d3",
                                "scale": {
                                    "domain": domain
                                },
                                "type": "quantitative",
                                "axis": {
                                    "title": "",
                                    "tickCount": axis.tickCount
                                }
                            },
                            "y2": {
                                "field": "d4",
                                "type": "quantitative"
                            },
                            "x": {
                                // This defines the x-axis and label
                                "field": "date1",
                                "type": "temporal",
                                "axis": {
                                    "title": "",
                                },
                                "scale": {
                                    "domain": {
                                        "selection": "brush"
                                    }
                                }
                            },
                            "tooltip": null
                        }
                    }, {
                        // Cat 2 drought area layer
                        "mark": {
                            "opacity": 1.0,
                            "type": "area",
                            "color": legend["D2"]
                        },
                        "encoding": {
                            "y": {
                                "field": "d2",
                                "scale": {
                                    "domain": domain
                                },
                                "type": "quantitative",
                                "axis": {
                                    "title": "",
                                    "tickCount": axis.tickCount
                                }
                            },
                            "y2": {
                                "field": "d3",
                                "type": "quantitative"
                            },
                            "x": {
                                // This defines the x-axis and label
                                "field": "date1",
                                "type": "temporal",
                                "axis": {
                                    "title": "",
                                },
                                "scale": {
                                    "domain": {
                                        "selection": "brush"
                                    }
                                }
                            },
                            "tooltip": null
                        }
                    }, {
                        // Cat 1 drought area layer
                        "mark": {
                            "opacity": 1.0,
                            "type": "area",
                            "color": legend["D1"]
                        },
                        "encoding": {
                            "y": {
                                "field": "d1",
                                "scale": {
                                    "domain": domain
                                },
                                "type": "quantitative",
                                "axis": {
                                    "title": "",
                                    "tickCount": axis.tickCount
                                }
                            },
                            "y2": {
                                "field": "d2",
                                "type": "quantitative"
                            },
                            "x": {
                                // This defines the x-axis and label
                                "field": "date1",
                                "type": "temporal",
                                "axis": {
                                    "title": "",
                                },
                                "scale": {
                                    "domain": {
                                        "selection": "brush"
                                    }
                                }
                            },
                            "tooltip": null
                        }
                    }, {
                        // Cat 0 drought area layer
                        "mark": {
                            "opacity": 1.0,
                            "type": "area",
                            "color": legend["D0"]
                        },
                        "encoding": {
                            "y": {
                                "field": "d0",
                                "scale": {
                                    "domain": domain
                                },
                                "type": "quantitative",
                                "axis": {
                                    "title": "",
                                    "tickCount": axis.tickCount
                                }
                            },
                            "y2": {
                                "field": "d1",
                                "type": "quantitative"
                            },
                            "x": {
                                // This defines the x-axis and label
                                "field": "date1",
                                "type": "temporal",
                                "axis": {
                                    "title": "",
                                },
                                "scale": {
                                    "domain": {
                                        "selection": "brush"
                                    }
                                }
                            },
                            "tooltip": null
                        }
                    }, {
                        // Not in drought area layer
                        "mark": {
                            "opacity": 1.0,
                            "type": "area",
                            "color": legend["DN"]
                        },
                        "encoding": {
                            "y": {
                                "field": "d0",
                                "scale": {
                                    "domain": domain
                                },
                                "type": "quantitative",
                                "axis": {
                                    "title": "",
                                    "tickCount": axis.tickCount
                                }
                            },
                            "y2": {
                                "field": "dn",
                                "type": "quantitative"
                            },
                            "x": {
                                // This defines the x-axis and label
                                "field": "date1",
                                "type": "temporal",
                                "axis": {
                                    "title": "",
                                },
                                "scale": {
                                    "domain": {
                                        "selection": "brush"
                                    }
                                }
                            },
                            "tooltip": null
                        }
                    }, {
                        // NDMI Line
                        "mark": {
                            "type": "line",
                            "color": "#000000",
                            "opacity": 1.0,
                            "strokeDash": [1, 10],
                            "point": {
                                "type": "circle",
                                "size": 500,
                                "color": "#000000",
                                "opacity": 1.0
                            }
                        },
                        "encoding": {
                            "y": {
                                "field": "NDMI",
                                "scale": {
                                    "domain": domain
                                },
                                "type": "quantitative",
                                "axis": {
                                    "title": "",
                                    "tickCount": axis.tickCount
                                }
                            },
                            "x": {
                                // This defines the x-axis and label
                                "field": "date",
                                "type": "temporal",
                                "axis": {
                                    "title": "Date",
                                    "labelFontSize": 24,
                                    "titleFontSize": 24,
                                    "format": "%m/%d/%y",
                                    "labelAngle": -60,
                                },
                                "scale": {
                                    "domain": {
                                        "selection": "brush"
                                    }
                                }
                            }
                        }
                    }, {
                        // SMAP line
                        "mark": {
                            "type": "line",
                            "color": "#BB9999",
                            "size": "5",
                            "point": {
                                "type": "square",
                                "color": "#BB9999",
                                "size": "200"
                            }
                        },
                        "selection": {
                            // SELECTION IS HERE
                            "brush": {
                                "type": "interval",
                                "bind": "scales",
                                "encodings": ["x"]
                            }
                        },
                        "encoding": {
                            "y": {
                                "scale": {
                                    "domain": domain
                                },
                                "field": "moisture",
                                "type": "quantitative",
                            },
                            "x": {
                                // This defines the x-axis and label
                                "field": "date1",
                                "type": "temporal",
                                "axis": {
                                    "title": "",
                                },
                                "scale": {
                                    "domain": {
                                        "selection": "brush"
                                    }
                                }
                            }
                        }
                    }, ],
                    //                 "resolve": {
                    //                     "scale": {
                    //                         "y": "independent"
                    //                     }
                    //                 }
                };
                return vlSpec;
            }
        </script>
        <script>
            // First time run functions
            var geolocation = null;
            var old_geolocation = [null, null];
            var rawData = null;
            var marker = null;
            var coords = null;
            var coords2 = null;
            // used to get categories for specific NDMI dates
            var pipeline_category = null;
            var pipeline_moisture = null;
            var pipeline_d0 = null;
            var pipeline_d1 = null;
            var pipeline_d2 = null;
            var pipeline_d3 = null;
            var pipeline_d4 = null;
            var test_pipeline = null

            var PODPACcfg = {
                s3: null,
                inFolder: "esip_input",
                outFolder: 'esip_output'
            };

            // S3 Configuration
            var lambdaS3Bucket = 'podpac-s3';
            var s3 = null;
            $.getJSON('json/config.json', function(json) {
                AWS.config.update(json);
                s3 = new AWS.S3({
                    apiVersion: '2006-03-01',
                    params: {
                        Bucket: lambdaS3Bucket
                    }
                });
                PODPACcfg.s3 = s3;
            });

            $.getJSON('json/coords_template.json', function(json) {
                coords = json;
                get_data(geolocation, rawData);
            })
            $.getJSON('json/coords_template2.json', function(json) {
                coords2 = json;
                get_data(geolocation, rawData);
            })

            $.getJSON('json/pipeline_category.json', function(json) {
                pipeline_category = json;
                get_data(geolocation, rawData);
            })
            $.getJSON('json/pipeline_moisture.json', function(json) {
                pipeline_moisture = json;
                get_data(geolocation, rawData);
            })
            $.getJSON('json/pipeline_d0.json', function(json) {
                pipeline_d0 = json;
                get_data(geolocation, rawData);
            })
            $.getJSON('json/pipeline_d1.json', function(json) {
                pipeline_d1 = json;
                get_data(geolocation, rawData);
            })
            $.getJSON('json/pipeline_d2.json', function(json) {
                pipeline_d2 = json;
                get_data(geolocation, rawData);
            })
            $.getJSON('json/pipeline_d3.json', function(json) {
                pipeline_d3 = json;
                get_data(geolocation, rawData);
            })
            $.getJSON('json/pipeline_d4.json', function(json) {
                pipeline_d4 = json;
                get_data(geolocation, rawData);
            })
            $.getJSON('json/pipeline_template.json', function(json) {
                test_pipeline = json;
            })

            //             $("#vis").css('display', 'none');
            $("#map").css("height", get_height());

            // Create Leaflet Layers
            var OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });
            var DroughtWMSOptions = {
                layers: "usdm_current",
                transparent: true,
                transparency: true,
                opacity: 0.95,
                format: 'image/png'
            };
            var DroughtWMS = L.tileLayer.wms("http://ndmc-001.unl.edu:8080/cgi-bin/mapserv.exe?map=/ms4w/apps/usdm/service/usdm_current_wms.map&", DroughtWMSOptions);

            var baseMaps = {
                "osm": OpenStreetMap_Mapnik
            };
            var overlayMaps = {
                "NDMI": DroughtWMS
            };

            // Initial leaflet MAP
            var map = L.map('map', {
                center: [42, -100.0],
                zoom: 4,
                layers: [OpenStreetMap_Mapnik]
            });
            L.control.layers(baseMaps, overlayMaps).addTo(map);

            // Set up listeners etc. to handle specification for the markers
            map.on('click', function(e) {
                if (geolocation !== null & geolocation !== undefined) {
                    return;
                }
                var coords = e.latlng;
                $("#lat")[0].value = coords['lat'];
                $("#lon")[0].value = coords['lng'];
                updatePlot();

            })

            // Update the line plot
            updatePlot();
        </script>
    </body>
</html>
